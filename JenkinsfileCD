def notifySlack(String buildStatus = 'STARTED') {
    // Build status of null means success.
    buildStatus = buildStatus ?: 'SUCCESS'

    def color

    if (buildStatus == 'STARTED') {
        color = '#D4DADF'
    } else if (buildStatus == 'SUCCESS') {
        color = '#BDFFC3'
    } else if (buildStatus == 'UNSTABLE') {
        color = '#FFFE89'
    } else {
        color = '#FF9FA1'
    }

    def msg = "${buildStatus}: `${env.JOB_NAME}` #${env.BUILD_NUMBER}:\n${env.BUILD_URL}"

    slackSend(color: color, message: msg)
}

pipeline {
    agent any

	environment {
		currentBuildNumber = "${env.BUILD_NUMBER}"
	} // environment

	tools {
            maven 'Maven 3.6.3'
            jdk 'jdk8'

     } // tools


    stages {
        stage('Code, config. & infra. Deploy') {
        steps {

				sh '/usr/local/bin/kubectl apply -f kube_deployment.yaml '

            } // step
        } // stage
        stage('Functional tests execution') {
            steps {
                echo 'Functional Testing..'
				sh '''
				serviceClusterIP=`/usr/local/bin/kubectl describe service books-service | grep IP | awk '{print $2}'`
				mvn -f functionalTest/pom.xml test -Dserver.basehost=http://${serviceClusterIP} -Dserver.base=books
				'''
            } // steps
        } // stage
     } // stages

     post {
                 // only triggered when blue or green sign
                 always  {
                     notifySlack(currentBuild.result)
                 }

              } // post


} // pipeline
